name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write  # OIDC í† í°ì„ ìœ„í•´ í•„ìš”

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          # Claude Code OAuth í† í° ì‚¬ìš© (Max í”Œëœ)
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # íŠ¸ë¦¬ê±° ë¬¸êµ¬ ì„¤ì • (ê¸°ë³¸ê°’: @claude)
          trigger_phrase: "@claude"
          
          # PRì— ëŒ€í•œ ìë™ ë¦¬ë·° í”„ë¡¬í”„íŠ¸
          prompt: |
            ì´ PRì˜ ë³€ê²½ì‚¬í•­ì„ ê²€í† í•˜ê³  ë‹¤ìŒ ì‚¬í•­ì— ëŒ€í•´ í•œêµ­ì–´ë¡œ ìƒì„¸í•œ ë¦¬ë·°ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”:
            
            1. ì½”ë“œ í’ˆì§ˆ ë° ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤
            2. ì ì¬ì  ë²„ê·¸ë‚˜ ì˜¤ë¥˜
            3. ë³´ì•ˆ ì·¨ì•½ì 
            4. ì„±ëŠ¥ ìµœì í™” ê¸°íšŒ
            5. ì½”ë“œ ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„±
            6. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
            
            ê° íŒŒì¼ì˜ ë³€ê²½ì‚¬í•­ì— ëŒ€í•´ êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•˜ê³ ,
            ê°œì„  ì‚¬í•­ì´ ìˆë‹¤ë©´ ì½”ë“œ ì˜ˆì‹œì™€ í•¨ê»˜ ì œì•ˆí•´ì£¼ì„¸ìš”.
          
          # Claude CLI ì¶”ê°€ ì¸ì
          claude_args: |
            --max-turns 10
            --model claude-3-5-sonnet-20241022
          
          # PR ì½”ë©˜íŠ¸ë¥¼ í•˜ë‚˜ì˜ ìŠ¤í‹°í‚¤ ì½”ë©˜íŠ¸ë¡œ í†µí•©
          use_sticky_comment: true
          
          # ë¸Œëœì¹˜ ì„¤ì •
          base_branch: main
          branch_prefix: claude/
          
          # ì´ìŠˆ í• ë‹¹ì íŠ¸ë¦¬ê±°
          assignee_trigger: claude
          
          # ì´ìŠˆ ë¼ë²¨ íŠ¸ë¦¬ê±°  
          label_trigger: claude-help

      - name: Post Review Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## ğŸ¤– Claude Code Review ì™„ë£Œ
            
            ë¦¬ë·°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. PR ì½”ë©˜íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
            
            ### ë¦¬ë·° í¬ì¸íŠ¸
            - ì½”ë“œ í’ˆì§ˆ ë° ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤
            - ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
            - ì„±ëŠ¥ ìµœì í™” ì œì•ˆ
            - ë²„ê·¸ ê°€ëŠ¥ì„± ê²€í† 
            `;
            
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

  # íŠ¹ì • ë¼ë²¨ì´ ë¶™ì€ ì´ìŠˆì— ëŒ€í•œ ìë™ ì‘ë‹µ
  claude-assist:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'claude-help')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Claude Assistance
        uses: anthropics/claude-code-action@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: claude-3-5-sonnet-20241022
          respond_to_issues: true
          custom_instructions: |
            ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  ë‹¤ìŒì„ ì œê³µí•´ì£¼ì„¸ìš”:
            1. ë¬¸ì œ í•´ê²° ë°©ì•ˆ
            2. êµ¬í˜„ ì˜ˆì‹œ ì½”ë“œ
            3. ê´€ë ¨ ë¬¸ì„œ ë˜ëŠ” ë¦¬ì†ŒìŠ¤
            
            PLAYAUTO í”„ë¡œì íŠ¸ì˜ êµ¬ì¡°ì™€ ê¸°ìˆ  ìŠ¤íƒì„ ê³ ë ¤í•˜ì—¬ ë‹µë³€í•´ì£¼ì„¸ìš”.
            ëª¨ë“  ë‹µë³€ì€ í•œê¸€ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.